<!DOCTYPE html>
<html lang="{{ site.lang | default: 'en-US' }}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <meta name="description" content="{{ site.description }}">
</head>
<body>
    <div class="site-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="{{ '/' | relative_url }}">Home</a></li>
                    {% if site.lessons and site.lessons.size > 0 %}
                        <li><a href="{{ '/' | relative_url }}">All Lessons</a></li>
                    {% else %}
                        <li><a href="{{ '/ACTIVITY_GUIDE.html' | relative_url }}">Activity Guide</a></li>
                        <li><a href="{{ '/project-guide-show-me.html' | relative_url }}">Project Guide</a></li>
                        <li><a href="{{ '/OVERALL_PLAN.html' | relative_url }}">Overall Plan</a></li>
                    {% endif %}
                </ul>
                
                {% comment %} Determine current lesson from page URL or page data {% endcomment %}
                {% assign current_lesson = nil %}
                {% assign collection_name = nil %}
                
                {% comment %} First, try to get lesson from page data (for lesson-home pages) {% endcomment %}
                {% if page.lesson and page.lesson.slug %}
                    {% assign current_lesson = page.lesson %}
                    {% assign collection_name = page.lesson.slug | append: '-levels' %}
                {% elsif page.lesson_slug %}
                    {% assign collection_name = page.lesson_slug | append: '-levels' %}
                {% elsif site.lessons and site.lessons.size > 0 %}
                    {% for lesson in site.lessons %}
                        {% if page.url contains lesson.url or page.url contains lesson.slug %}
                            {% assign current_lesson = lesson %}
                            {% assign collection_name = lesson.slug | append: '-levels' %}
                            {% break %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                
                {% comment %} Fallback to default collection name {% endcomment %}
                {% unless collection_name %}
                    {% assign collection_name = site.level_manager.collection_name | default: 'levels' %}
                {% endunless %}
                
                {% comment %} Try apple-clicker-levels if URL contains apple-clicker {% endcomment %}
                {% if page.url contains 'apple-clicker' and collection_name == 'levels' %}
                    {% assign collection_name = 'apple-clicker-levels' %}
                {% endif %}
                
                {% if current_lesson %}
                    <h3>{{ current_lesson.title }} - Levels</h3>
                {% else %}
                    <h3>Levels</h3>
                {% endif %}
                
                <ul class="level-nav">
                    {% if collection_name == 'apple-clicker-levels' %}
                        {% assign sorted_levels = site.apple-clicker-levels | sort: 'number' %}
                    {% elsif collection_name == 'example-lesson-levels' %}
                        {% assign sorted_levels = site.example-lesson-levels | sort: 'number' %}
                    {% else %}
                        {% assign levels_collection = site.collections[collection_name] %}
                        {% if levels_collection and levels_collection.docs %}
                            {% assign sorted_levels = levels_collection.docs | sort: 'number' %}
                        {% endif %}
                    {% endif %}
                    {% if sorted_levels and sorted_levels.size > 0 %}
                        {% assign current_level_num = page.number %}
                        {% for level in sorted_levels %}
                            {% if level.number == current_level_num %}
                                <li><a href="{{ level.url | relative_url }}" class="active">Level {{ level.number }}: {{ level.subtitle }}</a></li>
                            {% else %}
                                <li><a href="{{ level.url | relative_url }}">Level {{ level.number }}: {{ level.subtitle }}</a></li>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <li>No levels found</li>
                    {% endif %}
                </ul>
                
                {% if current_lesson %}
                    <div class="spa-link">
                        <a href="{{ current_lesson.url | relative_url }}/all-levels-spa.html" class="btn-spa">ðŸ“„ View All Levels</a>
                    </div>
                {% else %}
                    <div class="spa-link">
                        {% assign spa_page = site.level_manager.spa_page_name | default: 'all-levels-spa.html' %}
                        <a href="{{ spa_page | relative_url }}" class="btn-spa">ðŸ“„ View All Levels</a>
                    </div>
                {% endif %}
            </nav>
        </aside>
        <main class="main-content">
            <article class="content">
                {{ content }}
            </article>
        </main>
    </div>
</body>
</html>
